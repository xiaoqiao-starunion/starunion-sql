
select  count(distinct role_id) as uv,count(1) as pv,
	sum(price) as price_total,
	conf_id,price,conf_id_group,conf_id_type,
	server_id,time_range
from(
select role_id,price,
	conf_id,conf_id_group,conf_id_type,
	pay_day,server_id,open_day,
	case when diff between 0 and 6 then '第一周'
	when diff between 7 and 13 then '第二周'
	when diff between 14 and 20 then '第三周'
	when diff between 21 and 27 then '第四周'
	when diff between 28 and 34 then '第五周'
	when diff between 35 and 41 then '第六周'
	when diff between 42 and 48 then '第七周'
	when diff between 49 and 55 then '第八周'
	when diff between 56 and 62 then '第九周'
	when diff between 63 and 69 then '第十周'
	when diff between 70 and 76 then '第十一周'
	when diff between 77 and 83 then '第十二周'
	when diff between 84 and 90 then '第十三周'
	when diff between 91 and 97 then '第十四周'
	when diff between 98 and 104 then '第十五周'
	when diff between 105 and 111 then '第十六周'
	else '其他' end as time_range


from
(
select  role_id,price,
	conf_id,conf_id_group,conf_id_type,
	pay_day,server_id,open_day,
	date_diff('day',date_parse ( open_day, '%Y-%m-%d' ),
				date_parse ( pay_day, '%Y-%m-%d' )) diff  
from
(
select role_id,server_id,conf_id,conf_id_group,conf_id_type,price,DATE_FORMAT(FROM_UNIXTIME(created_at) AT TIME ZONE 'utc','%Y-%m-%d') as pay_day
from payments
where is_paid=1
	and is_test=2
	and status=2
	and role_id in (select uuid from roles where is_internal=false and server_id!='2')
)as pay
inner join 
(select uuid,DATE_FORMAT(FROM_UNIXTIME(created_at) AT TIME ZONE 'utc','%Y-%m-%d') as open_day
from servers
where try_cast(uuid as integer) between 179 and 270
) as servs
on servs.uuid=pay.server_id
)as tmp
)group by conf_id,price,conf_id_group,conf_id_type,
	server_id,time_range